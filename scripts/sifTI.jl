using TensND, LinearAlgebra, SymPy, Tensors, OMEinsum, Rotations, Latexify
sympy.init_printing(use_unicode=true)

ğ•€, ğ•, ğ•‚ = ISO(Val(3),Val(Sym))
ğŸ = tensId2(Val(3),Val(Sym))

E, k, Î¼ = symbols("E k Î¼", positive = true)
Î½ = symbols("Î½", real = true)
k = E / (3(1-2Î½)) ; Î¼ = E / (2(1+Î½))
Î» = k -2Î¼/3

function Walpole_Basis(ğ§)
    T = eltype(ğ§)
    ğŸ = tensId2(3, T)
    ğ© = ğ§âŠ—ğ§ ; ğª=ğŸ-ğ©
    return ğ©âŠ—ğ©, ğªâŠ—ğª/2, ğ©âŠ—ğª/âˆš(T(2)), ğªâŠ—ğ©/âˆš(T(2)), ğªâŠ Ë¢ğª-ğªâŠ—ğª/2, ğªâŠ Ë¢ğ©+ğ©âŠ Ë¢ğª
end

function Walpole_Basis_sym(ğ§)
    T = eltype(ğ§)
    ğŸ = tensId2(3, T)
    ğ© = ğ§âŠ—ğ§ ; ğª=ğŸ-ğ©
    return ğ©âŠ—ğ©, ğªâŠ—ğª/2, ğ©âŠ—ğª/âˆš(T(2))+ğªâŠ—ğ©/âˆš(T(2)), ğªâŠ Ë¢ğª-ğªâŠ—ğª/2, ğªâŠ Ë¢ğ©+ğ©âŠ Ë¢ğª
end

function Walpole(t::AbstractTens,ğ„)
    return ntuple(i->tâŠ™ğ„[i]/(ğ„[i]âŠ™ğ„[i]),length(ğ„))
end

function Walpole(t,ğ„)
    return sum([Ï„*ğ„[i] for (i,Ï„) âˆˆ enumerate(t)])
end

ğ§ = ğ(3)

ğ„Ë¢ = Walpole_Basis_sym(ğ§)

w = Walpole(ğ•‚,ğ„Ë¢)

function defTI(Tâ‚â‚â‚â‚, Tâ‚â‚â‚‚â‚‚, Tâ‚â‚â‚ƒâ‚ƒ, Tâ‚ƒâ‚ƒâ‚ƒâ‚ƒ, Tâ‚‚â‚ƒâ‚‚â‚ƒ, nÌ± = tensbasis(CanonicalBasis{3,typeof(Tâ‚â‚â‚â‚)}(), 3))
    T = eltype(nÌ±)
    ğ• = Walpole_Basis_sym(nÌ±)
    ğ•‹ = Tâ‚ƒâ‚ƒâ‚ƒâ‚ƒ * ğ•[1] + (Tâ‚â‚â‚â‚ + Tâ‚â‚â‚‚â‚‚) * ğ•[2] + âˆš(T(2)) * Tâ‚â‚â‚ƒâ‚ƒ * ğ•[3] + (Tâ‚â‚â‚â‚ - Tâ‚â‚â‚‚â‚‚) * ğ•[4] + 2 * Tâ‚‚â‚ƒâ‚‚â‚ƒ * ğ•[5]
    return ğ•‹
end

function defcompTI(Eâ‚, Eâ‚ƒ, Î½â‚â‚‚, Î½â‚ƒâ‚, Gâ‚ƒâ‚, nÌ± = tensbasis(CanonicalBasis{3,typeof(Eâ‚)}(), 3))
    T = eltype(nÌ±)
    ğ• = Walpole_Basis_sym(nÌ±)
    Tâ‚â‚â‚â‚ = inv(Eâ‚)
    Tâ‚ƒâ‚ƒâ‚ƒâ‚ƒ = inv(Eâ‚ƒ)
    Tâ‚â‚â‚‚â‚‚ = -Î½â‚â‚‚ / Eâ‚
    Tâ‚â‚â‚ƒâ‚ƒ = -Î½â‚ƒâ‚ / Eâ‚ƒ
    Tâ‚‚â‚ƒâ‚‚â‚ƒ = inv(4Gâ‚ƒâ‚)
    ğ•‹ = Tâ‚ƒâ‚ƒâ‚ƒâ‚ƒ * ğ•[1] + (Tâ‚â‚â‚â‚ + Tâ‚â‚â‚‚â‚‚) * ğ•[2] + âˆš(T(2)) * Tâ‚â‚â‚ƒâ‚ƒ * ğ•[3] + (Tâ‚â‚â‚â‚ - Tâ‚â‚â‚‚â‚‚) * ğ•[4] + 2 * Tâ‚‚â‚ƒâ‚‚â‚ƒ * ğ•[5]
    return ğ•‹
end

function argTI(â„‚, nÌ± = tensbasis(getbasis(â„‚), 3))
    C = tensbasis(getbasis(â„‚), 3) == nÌ± ? â„‚ : change_tens(â„‚, Basis(angles(components_canon(nÌ±))...))
    return C[1, 1, 1, 1], C[1, 1, 2, 2], C[1, 1, 3, 3], C[3, 3, 3, 3], C[2, 3, 2, 3]
end

function argcompTI(ğ•Š, nÌ± = tensbasis(getbasis(ğ•Š), 3))
    S = tensbasis(getbasis(ğ•Š), 3) == nÌ± ? ğ•Š : change_tens(ğ•Š, Basis(angles(components_canon(nÌ±))...))
    Eâ‚ = inv(S[1, 1, 1, 1])
    Eâ‚ƒ = inv(S[3, 3, 3, 3])
    Î½â‚â‚‚ = -Eâ‚ * S[1, 1, 2, 2]
    Î½â‚ƒâ‚ = -Eâ‚ƒ * S[1, 1, 3, 3]
    Gâ‚ƒâ‚ = inv(4S[2, 3, 2, 3])
    return Eâ‚, Eâ‚ƒ, Î½â‚â‚‚, Î½â‚ƒâ‚, Gâ‚ƒâ‚
end

function B_TI(Î·::Sym, â„¬, Câ‚â‚â‚â‚, Câ‚â‚â‚‚â‚‚, Câ‚â‚â‚ƒâ‚ƒ, Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ, Câ‚‚â‚ƒâ‚‚â‚ƒ)
    T = Sym
    ÏƒáµÂ² = (Câ‚â‚â‚â‚ * Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ - Câ‚â‚â‚ƒâ‚ƒ^2 - 2Câ‚â‚â‚ƒâ‚ƒ * Câ‚‚â‚ƒâ‚‚â‚ƒ) / (Câ‚‚â‚ƒâ‚‚â‚ƒ * Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ)
    Ï€áµ = âˆš(Câ‚â‚â‚â‚ / Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ)
    Ïƒáµ = symbols("Ïƒáµ", real = true)
    Ïƒáµ = âˆš(ÏƒáµÂ² + 2Ï€áµ)
    Râ‚â‚â‚â‚ = -1 / Ïƒáµ * (1 / Câ‚‚â‚ƒâ‚‚â‚ƒ + 1 / âˆš(Câ‚â‚â‚â‚ * Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ))
    Râ‚â‚â‚ƒâ‚ƒ = 1 / Ïƒáµ * (Câ‚â‚â‚ƒâ‚ƒ + Câ‚‚â‚ƒâ‚‚â‚ƒ) / (Câ‚‚â‚ƒâ‚‚â‚ƒ * Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ)
    Râ‚ƒâ‚ƒâ‚ƒâ‚ƒ = 1 / Ïƒáµ * (âˆš(Câ‚â‚â‚â‚ / Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ) - Câ‚â‚â‚ƒâ‚ƒ * (Câ‚â‚â‚ƒâ‚ƒ + 2Câ‚‚â‚ƒâ‚‚â‚ƒ) / (Câ‚‚â‚ƒâ‚‚â‚ƒ * Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ)) / Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ
    Râ‚‚â‚ƒâ‚‚â‚ƒ = 1 / (4 * âˆš(T(2))) * âˆš((Câ‚â‚â‚â‚ - Câ‚â‚â‚‚â‚‚) / Câ‚‚â‚ƒâ‚‚â‚ƒ^3)
    Râ‚ƒâ‚â‚ƒâ‚ = 1 / (4Ïƒáµ) * (Câ‚â‚â‚â‚ * Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ - Câ‚â‚â‚ƒâ‚ƒ^2) / (Câ‚‚â‚ƒâ‚‚â‚ƒ^2 * Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ)
    Î·Â² = Î·^2
    kÂ² = 1 - Î·Â²
    â„°, ğ’¦ = symbols("â„°, ğ’¦", real = true)
    â„° = sympy.elliptic_e(kÂ²)
    ğ’¦ = sympy.elliptic_k(kÂ²)
    Iâ‚€ = â„° / Î·Â²
    Iâ‚‚ = kÂ² == 0 ? PI / 4 : (ğ’¦ - â„°) / kÂ²
    Bâ‚™â‚™ = 4 / (3Î·) / (Iâ‚€ * (Câ‚â‚â‚ƒâ‚ƒ^2 * Râ‚â‚â‚â‚ + 2Câ‚â‚â‚ƒâ‚ƒ * Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ * Râ‚â‚â‚ƒâ‚ƒ + Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ^2 * Râ‚ƒâ‚ƒâ‚ƒâ‚ƒ))
    Bâ‚—â‚— = 1 / (3Î·) / (Câ‚‚â‚ƒâ‚‚â‚ƒ^2 * ((Iâ‚€ - Iâ‚‚) * Râ‚‚â‚ƒâ‚‚â‚ƒ + Iâ‚‚ * Râ‚ƒâ‚â‚ƒâ‚))
    Bâ‚˜â‚˜ = 1 / (3Î·) / (Câ‚‚â‚ƒâ‚‚â‚ƒ^2 * ((Iâ‚€ - Iâ‚‚) * Râ‚ƒâ‚â‚ƒâ‚ + Iâ‚‚ * Râ‚‚â‚ƒâ‚‚â‚ƒ))
    ğ = Tens(Diagonal([Bâ‚—â‚—, Bâ‚˜â‚˜, Bâ‚™â‚™]), â„¬)
    nÌ± = tensbasis(â„¬, 3)
    â„ = 3 / 4 * nÌ± âŠ—Ë¢ ğ âŠ—Ë¢ nÌ±
    return ğ, â„
end

Câ‚â‚â‚â‚, Câ‚â‚â‚‚â‚‚, Câ‚â‚â‚ƒâ‚ƒ, Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ, Câ‚‚â‚ƒâ‚‚â‚ƒ = symbols("Câ‚â‚â‚â‚, Câ‚â‚â‚‚â‚‚, Câ‚â‚â‚ƒâ‚ƒ, Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ, Câ‚‚â‚ƒâ‚‚â‚ƒ", real = true)

Î·, a = symbols("Î·, a", positive = true)

â„¬ = Basis()
ğ, â„ = B_TI(Î·::Sym, â„¬, Câ‚â‚â‚â‚, Câ‚â‚â‚‚â‚‚, Câ‚â‚â‚ƒâ‚ƒ, Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ, Câ‚‚â‚ƒâ‚‚â‚ƒ)

Î¸ = symbols("Î¸", positive = true)
d = âˆš(Î·^2*cos(Î¸)^2+sin(Î¸)^2)
ğ› = (Î·*cos(Î¸) * ğ(1) + sin(Î¸) * ğ(2))/d
ğ›• = (-sin(Î¸) * ğ(1) + Î·*cos(Î¸) * ğ(2))/d

â„¬Ì„ = Basis(hcat(ğ›,ğ›•,ğ§))

for ğ¯ âˆˆ (:ğ›•,:ğ›) 
    @eval $(ğ¯) = tsimplify(change_tens($(ğ¯),â„¬Ì„))
end

Bâ‚™â‚™á¶œÊ¸Ë¡ = 3PI/8 * limit(ğ[3,3]/Î·, Î·=>0)
Bâ‚˜â‚˜á¶œÊ¸Ë¡ = 3PI/8 * limit(ğ[2,2]/Î·, Î·=>0)
Bâ‚—â‚—á¶œÊ¸Ë¡ = 3PI/8 * limit(ğ[1,1]/Î·, Î·=>0)

ğá¶œÊ¸Ë¡ =  Bâ‚—â‚—á¶œÊ¸Ë¡ * ğ›•âŠ—ğ›• + Bâ‚˜â‚˜á¶œÊ¸Ë¡ * ğ›âŠ—ğ› + Bâ‚™â‚™á¶œÊ¸Ë¡ * ğ§âŠ—ğ§ 
ğá¶œÊ¸Ë¡â»Â¹ =  (1/Bâ‚—â‚—á¶œÊ¸Ë¡) * ğ›•âŠ—ğ›• + (1/Bâ‚˜â‚˜á¶œÊ¸Ë¡) * ğ›âŠ—ğ› + (1/Bâ‚™â‚™á¶œÊ¸Ë¡) * ğ§âŠ—ğ§ 

p, q, Ï‰ = symbols("p, q, Ï‰", real = true)
ğ“ = q * (cos(Ï‰)*ğ(1) + sin(Ï‰)*ğ(2)) + p * ğ§

ğŠ = 3*PI^(3//2)/8 *âˆš(a*d/Î·) * ğá¶œÊ¸Ë¡â»Â¹â‹…ğâ‹…ğ“

Ká´µ = ğŠ[3]

â„‚ = defTI(Câ‚â‚â‚â‚, Câ‚â‚â‚‚â‚‚, Câ‚â‚â‚ƒâ‚ƒ, Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ, Câ‚‚â‚ƒâ‚‚â‚ƒ)

Ciso = 5. * ğ• + 5. * ğ•‚ + 0.0001*ğ„Ë¢[1]
valnum = (Câ‚â‚â‚â‚=>Ciso[1,1,1,1], Câ‚â‚â‚‚â‚‚=>Ciso[1,1,2,2], Câ‚â‚â‚ƒâ‚ƒ=>Ciso[1,1,3,3], Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ=>Ciso[3,3,3,3], Câ‚‚â‚ƒâ‚‚â‚ƒ=>Ciso[2,3,2,3],Î¸=>0*Ï€/3,Î·=>0.999999,a=>1.,Ï‰=>0*Ï€/6,q=>1.)

valnum = (Câ‚â‚â‚â‚=>5.8, Câ‚â‚â‚‚â‚‚=>1., Câ‚â‚â‚ƒâ‚ƒ=>2.1, Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ=>2.8, Câ‚‚â‚ƒâ‚‚â‚ƒ=>1.3,Î¸=>Ï€/5,Î·=>0.2,a=>0.5,Ï‰=>Ï€/3,p=>100.,q=>10000.)

ğŠâ¿á¶¸áµ = tsimplify(tsubs(ğŠ,valnum...).evalf())

A = Câ‚â‚â‚â‚*Câ‚‚â‚ƒâ‚‚â‚ƒ ; B = Câ‚â‚â‚ƒâ‚ƒ*(Câ‚â‚â‚ƒâ‚ƒ+2Câ‚‚â‚ƒâ‚‚â‚ƒ)-Câ‚â‚â‚â‚*Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ ; C = Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ*Câ‚‚â‚ƒâ‚‚â‚ƒ
Î” = B^2-4A*C ; nâ‚ = (-B+âˆšÎ”)/(2A) ; nâ‚‚ = (-B-âˆšÎ”)/(2A)
m(n) = (Câ‚â‚â‚â‚*n-Câ‚‚â‚ƒâ‚‚â‚ƒ)/(Câ‚â‚â‚ƒâ‚ƒ+Câ‚‚â‚ƒâ‚‚â‚ƒ)
nâ‚ƒ = 2Câ‚‚â‚ƒâ‚‚â‚ƒ/(Câ‚â‚â‚â‚-Câ‚â‚â‚‚â‚‚)
mm(n) = (Câ‚â‚â‚ƒâ‚ƒ+Câ‚‚â‚ƒâ‚‚â‚ƒ)*n/(Câ‚ƒâ‚ƒâ‚ƒâ‚ƒ-Câ‚‚â‚ƒâ‚‚â‚ƒ*n)
mâ‚ = m(nâ‚) ; mâ‚‚ = m(nâ‚‚)

Î±â‚‚ = (1+mâ‚)*(1+mâ‚‚)/(mâ‚-mâ‚‚)*(1/âˆšnâ‚-1/âˆšnâ‚‚) ; Î²â‚‚ = -1/âˆšnâ‚ƒ

b = a*Î·
Î·Â² = Î·^2
kÂ² = 1 - Î·Â²
â„° = sympy.elliptic_e(kÂ²)
ğ’¦ = sympy.elliptic_k(kÂ²)

Aâ‚ = a*b^2*kÂ²*q*cos(Ï‰)/((kÂ²-1+Î²â‚‚/Î±â‚‚)*â„°+(1-Î²â‚‚/Î±â‚‚)*Î·Â²*ğ’¦)/(2Î±â‚‚*Câ‚‚â‚ƒâ‚‚â‚ƒ)
Bâ‚ = a*b^2*kÂ²*q*sin(Ï‰)/((kÂ²+(1-Î²â‚‚/Î±â‚‚)*Î·Â²)*â„°-(1-Î²â‚‚/Î±â‚‚)*Î·Â²*ğ’¦)/(2Î±â‚‚*Câ‚‚â‚ƒâ‚‚â‚ƒ)

kâ‚‚ = 2Î±â‚‚*Câ‚‚â‚ƒâ‚‚â‚ƒ*(a*Bâ‚*sin(Î¸)+b*Aâ‚*cos(Î¸))/(a*b)^(3/2)/âˆš(a*d)*âˆš(PI) ;
kâ‚ƒ = -2Î²â‚‚*Câ‚‚â‚ƒâ‚‚â‚ƒ*(a*Aâ‚*sin(Î¸)-b*Bâ‚*cos(Î¸))/(a*b)^(3/2)/âˆš(a*d)*âˆš(PI) ;
kâ‚ = p/â„°*âˆš(b*d)*âˆš(PI) ;

real(simplify(subs(kâ‚‚,valnum...).evalf()))
real(simplify(subs(kâ‚ƒ,valnum...).evalf()))
simplify(subs(kâ‚,valnum...).evalf())

ğŠâ¿á¶¸áµ
